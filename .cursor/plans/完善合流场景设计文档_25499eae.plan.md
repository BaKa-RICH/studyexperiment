---
name: 完善合流场景设计文档
overview: 修正 SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md 中的 3 车道→4 车道不一致、lane 索引错误、合流机制变更（从 lane-drop 改为真实换道 + 算法仍用固定点）、以及段落语义不清等问题。
todos:
  - id: fix-title-global
    content: 修改标题和全文 3-lane → 4-lane 相关描述
    status: completed
  - id: fix-lane-index
    content: 修正 4.3.2 的 lane 索引为 SUMO 0-based (0-3)
    status: completed
  - id: fix-connections-h2h3
    content: 修正 4.4.1 连接映射（补齐 4 条 lane 映射）
    status: completed
  - id: redesign-conflict-B
    content: 重写 4.4.3 冲突点B（方式B：aux 无下游连接，换道合流）
    status: completed
  - id: fix-lanechange-section
    content: 更新 6.2 禁止换道描述（允许 aux 车换道到 lane1）
    status: completed
  - id: fix-control-target
    content: 更新 6.1 控制对象（4 lane 全有车流，只控冲突车道+aux）
    status: completed
  - id: fix-flow-defs
    content: 修正 7.2 流定义（3 条→4 条 mainline flow）
    status: completed
  - id: fix-edge-spec
    content: 修正 4.2.2 和 10.1 的 lane 数验收项
    status: completed
  - id: add-segment-table
    content: 新增各段语义与控制区关系总结表
    status: completed
  - id: add-impl-notes
    content: 新增方式B 的实现注意事项（d_to_merge 特殊处理、换道失败处理）
    status: completed
isProject: false
---

# 完善 SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md 设计文档

## 变更依据（讨论结论）

- 主线 **4 车道**（非 3 车道），匝道 2 车道
- Lane 索引统一用 **SUMO 0-based**（4-lane edge: lane0-3, 5-lane: lane0-4）
- 合流机制改为**方式B（真实换道）**：aux lane 在 n_merge 无下游连接，匝道车必须在 main_h3 内换道到 lane1；算法仍以进入 main_h4 为"过合流点"
- 主线 4 条 lane **全部有车流**，算法只控制冲突车道（main_h3 lane1）+ aux（lane0）上的车辆
- 各段长度保持论文值（H1=200, H2=300, H3=300, H4=200, ramp H5=100, H6=300）

---

## 修改清单

### 1. 标题与全局替换

- 标题从 "3-Lane Mainline + Aux Lane" 改为 "4-Lane Mainline + Aux Lane"
- 全文搜索 "3 条车道" / "3-lane" / "三车道" 相关描述，改为 4

### 2. 4.3.2 车道索引（lane index）修正

4-lane 主线 edge（main_h1/h2/h4）改为 SUMO 0-based：

```
lane 0: 主线最右车道（冲突车道候选）
lane 1: 主线中右车道
lane 2: 主线中左车道
lane 3: 主线最左车道
```

5-lane main_h3 不变（已经是 0-based）。

### 3. 4.4.1 连接映射（main_h2 → main_h3）修正

标题改为 "主线 4→5 车道"，补齐 4 条连接：

```
main_h2 lane0 → main_h3 lane1
main_h2 lane1 → main_h3 lane2
main_h2 lane2 → main_h3 lane3
main_h2 lane3 → main_h3 lane4
```

约束不变：不允许 main_h2 任何 lane 连接到 main_h3 lane0。

### 4. 4.4.3 冲突点B 重新设计（核心变更：方式B）

**旧设计**（lane-drop）：lane0 + lane1 → main_h4 lane0

**新设计**（真实换道）：

n_merge 连接：

```
main_h3 lane0 → 无下游连接（aux lane 到此终止）
main_h3 lane1 → main_h4 lane0
main_h3 lane2 → main_h4 lane1
main_h3 lane3 → main_h4 lane2
main_h3 lane4 → main_h4 lane3
```

新增描述：

- "冲突点B"不再是一个 junction 冲突点，而是**整个 main_h3 区域（300m）内匝道车从 lane0 换道到 lane1 的合流区间**
- 匝道车必须在到达 n_merge 前完成从 lane0 到 lane1 的换道
- SUMO 的内置换道模型自动处理换道时机
- 算法通过控速创造间隙，"过合流点"仍定义为进入 main_h4（`merge_edge`）

### 5. 6.2 禁止换道描述更新

原文说"禁止 main_h3 的 4 条 lane 之间横向移动"，需改为：

- **主线车辆（lane1-4）**：禁止自由换道，保持在各自车道
- **匝道车辆（lane0 / aux）**：**允许且必须**从 lane0 换到 lane1（否则 lane0 到头车辆会被卡住）
- 实现方式：对主线车辆设置 `laneChangeMode` 禁止换道；对 aux 上的匝道车不禁止（或仅允许 lane0→lane1 方向的换道）

### 6. 6.1 控制对象更新

E1 选项修正：

- 主线 4 条 lane 都生成车流
- 算法只控制 **main_h3 lane1**（冲突车道，由 main_h1/h2 lane0 流过来的车辆）和 **main_h3 lane0**（aux，匝道车辆）上的车
- 其余主线车辆（lane2-4）自由行驶，不被算法接管

### 7. 7.2 流定义修正

主线流（`[main_h1](docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md)`，4 lanes）改为 4 条 flow：

```
flow_main_L0: departLane="0"  (主线最右，→ main_h3 lane1 冲突车道)
flow_main_L1: departLane="1"
flow_main_L2: departLane="2"
flow_main_L3: departLane="3"  (主线最左)
```

匝道不变（2 条 flow，v1 只启用 lane1）。

### 8. 4.2.2 Edge 规格表修正

确认 lane 数：

- `main_h1/main_h2/main_h4`: lanes=**4**（非 3）
- `main_h3`: lanes=**5**（非 4）

### 9. 10.1 验收清单修正

- "main_h1/h2/h4 车道数=**4**；main_h3 车道数=**5**"
- n_merge 连接验收项改为：lane0 **无**下游连接，lane1-4 分别连接 main_h4 lane0-3

### 10. 新增：各段语义与控制区关系总结

在 4.1 或新建小节，添加清晰的表格：


| 段   | edge    | 论文区域      | 功能                   | 车道数 | 算法控制？                   |
| --- | ------- | --------- | -------------------- | --- | ----------------------- |
| H1  | main_h1 | L1 上游自由区  | 无控制                  | 4   | 否                       |
| H2  | main_h2 | L2 速控/变道区 | 进入控制区，算法开始接管         | 4   | 是（lane0 冲突车道）           |
| H3  | main_h3 | L3 协同合流区  | aux lane 并行，匝道车换道合流  | 5   | 是（lane0 aux + lane1 冲突） |
| H4  | main_h4 | L4 下游自由区  | merge_edge，过此即"过合流点" | 4   | 否                       |
| H5  | ramp_h5 | L5 匝道自由区  | 无控制                  | 2   | 否                       |
| H6  | ramp_h6 | L6 匝道速控区  | 进入控制区，算法开始接管         | 2   | 是                       |


### 11. 新增：方式B 的实现注意事项

- `d_to_merge` 对 main_h3 lane0 上的车辆可能需要特殊处理（因为 lane0 无下游连接，`getDrivingDistance` 可能返回异常值），实现时需验证
- 匝道车换道失败（堵在 lane0 末尾）的边界情况需要在实现时处理

---

## 不修改的部分

- 长度保持论文值
- 冲突点A 的描述不变（ramp 2 lane → aux lane 的连接）
- 速度、优先级等（第 5 节）保持不变
- 车辆类型（第 8 节）保持不变
- 仿真参数（第 9 节）保持不变


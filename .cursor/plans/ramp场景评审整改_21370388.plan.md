---
name: Ramp场景评审整改
overview: 采用“先纯SUMO零代码跑通、再最小代码适配”的阶段门控路线，修正文档冲突并补齐多车道方式B的关键语义（E-ctrl/E-flow、stream_vmax、check_plans范围），最终形成可复现基线。
todos:
  - id: spec-contract-upgrade
    content: 升级规格契约（“无需改代码”措辞、E-ctrl/E-flow拆分、priority统一、控制判定伪代码、stream_vmax口径）
    status: pending
  - id: sumo-zero-code-gate
    content: 先完成纯SUMO层建网与no_control零代码验收（作为代码改造前置门槛）
    status: pending
  - id: runtime-minimal-adapt
    content: 在通过零代码门槛后再做最小runtime适配（lane过滤、laneChangeMode、按需d_to_merge修正）
    status: pending
  - id: stream-vmax-decision-ab
    content: 冻结匝道车在aux lane上的effective_vmax语义，并做A/B验证后固化
    status: pending
  - id: check-plans-mlane-adapt
    content: 适配check_plans到多车道场景（受控车辆范围过滤与字段补全）
    status: pending
  - id: validation-matrix-freeze
    content: 建立并冻结多seed基线矩阵（结构+行为+一致性指标）
    status: pending
isProject: false
---

# Ramp场景设计评审与整改计划（完善版）

## 范围与决策

- 已确认主策略：允许最小代码改造；控制范围按 `H2+H3`（主线）与 `H6+H3`（匝道）共 `600m`。
- 核心约束：尽量不改 `dp_schedule/fifo` 的核心调度模型，仅做 runtime 层必要适配。
- 改造对象：
  - 规范文档：[docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md](docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md)
  - 运行时逻辑：[ramp/runtime/state_collector.py](ramp/runtime/state_collector.py)、[ramp/runtime/controller.py](ramp/runtime/controller.py)
  - 调度封装：[ramp/policies/dp/scheduler.py](ramp/policies/dp/scheduler.py)、[ramp/policies/fifo/scheduler.py](ramp/policies/fifo/scheduler.py)
  - 校验工具：[ramp/experiments/check_plans.py](ramp/experiments/check_plans.py)
  - 场景文件：`ramp/scenarios/<new_scenario>/` 下的 `.nod/.edg/.net/.rou/.sumocfg`

## 关键问题（按优先级）

- P0：文档内部冲突——“无需改代码跑通”与后文要求 `lane_id` 过滤、`laneChangeMode`、`d_to_merge` 处理并存。
- P0：E1/E2 在第6节与第7节语义冲突（控制范围 vs 出流范围混用同标签）。
- P0：`stream_vmax` 语义缺失——匝道车进入 `main_h3 lane0` 后是否按 `25 m/s` 估计 ETA/t_min 未冻结。
- P1：`d_to_merge` 在 aux lane 的风险评估应改为“先验收后改造”，而不是先入为主强制改代码。
- P1：控制范围表述需明确为“距离条件 AND 车道条件”的组合逻辑。
- P2：priority 规格表与建议不一致（低成本文档修复项）。
- P2：多车道阶段 `check_plans` 可能出现范围误判，需要补充受控范围过滤能力。

## 设计口径冻结（先写入规范）

- 标签拆分：
  - `E-ctrl-1`：只控冲突车道（推荐）
  - `E-ctrl-2`：控制全车道
  - `E-flow-1`：仅冲突车道出流
  - `E-flow-2`：全车道出流（推荐）
- v1 推荐组合：`E-flow-2 + E-ctrl-1`（全车道有流量，但只控制冲突车道）。
- 控制判定统一为 AND 逻辑（写入规范第6节）：

```python
in_control_zone = 0 < d_to_merge <= 600.0
is_conflict_lane = (
    (stream == "ramp") or
    (stream == "main" and lane_is_conflict_lane)
)
is_controlled = in_control_zone and is_conflict_lane
```

- 兼容性措辞修订：将“无需改代码跑通”改为“核心调度算法无需改动，runtime 允许最小适配”。
- priority 口径修订：边表与建议统一（主线与匝道同优先级）。

## 实施顺序（阶段门控）

### M0 文档契约修订（先做）

- 更新 [docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md](docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md)：
  - 修正“无需改代码”措辞；
  - 完成 `E-ctrl/E-flow` 拆分；
  - 明确 AND 过滤逻辑；
  - 统一 priority 口径；
  - 补 `stream_vmax` 决策条目与验证方式。

### M1 纯SUMO层建网与零代码验收（代码改造前置门槛）

- 新建多车道场景目录（不覆盖 `ramp_min_v1`），完成 `.nod/.edg/.net/.rou/.sumocfg`。
- 仅用现有代码跑 `no_control`，不改 Python 逻辑，先验证路网可运行。
- 必过门槛：
  - 结构：edge/lane/connection/route/flow 与规范一致；
  - 行为：匝道车可从 aux lane 换入主线，不出现系统性死锁；
  - 数据：`control_zone_trace.csv` 中 aux lane 车辆 `d_to_merge` 无大面积异常值。
- 结果分流：
  - 若 aux lane `d_to_merge` 正常：保留现有逻辑，不做额外补丁；
  - 若异常：进入 M2 执行最小修复。

### M2 runtime 最小适配（仅在 M1 通过后）

- 在 [ramp/runtime/state_collector.py](ramp/runtime/state_collector.py) 实现受控对象 lane 过滤（按规范冲突车道集合）。
- 在 [ramp/runtime/controller.py](ramp/runtime/controller.py) 增加角色化 `laneChangeMode` 处理：
  - 主线车辆禁自由换道；
  - aux 匝道车允许换道至主线冲突车道。
- `d_to_merge` 仅按 M1 结果按需修复，避免无必要改动。

### M3 `stream_vmax` 语义冻结与A/B确认

- 在调度 ETA/t_min 中明确 `effective_vmax` 口径，并做 A/B：
  - A：按 stream 固定上限（ramp 恒 `16.7`）；
  - B：按有效车道上限（aux lane 可用 `25.0`）。
- 对比吞吐、delay、mismatch、稳定性后冻结唯一方案并写回规范与蓝图。

### M4 `check_plans` 多车道适配

- 在 [ramp/experiments/check_plans.py](ramp/experiments/check_plans.py) 增加“受控范围过滤”能力，避免多车道阶段误报。
- 必要时在 `plans.csv` 增加用于过滤的最小字段（如 `lane_id` 或控制标签）。

### M5 基线回归冻结

- 跑固定 seed 矩阵（`no_control/fifo/dp`）并保存结果。
- 形成结构、行为、一致性三类验收结论，作为后续改造锚点。

## 验收标准

- L1（M1门槛）：零代码 `no_control` 可稳定跑通并输出完整结果。
- L2（结构）：`net/rou/sumocfg` 满足规范 edge/lane/connection/route/flow 契约。
- L3（行为）：aux lane 换道链路稳定，`d_to_merge`、`commit`、`cross_merge`、`entry` 事件语义一致。
- L4（策略）：`fifo/dp` 只对约定冲突车道接管，`check_plans` 在正确范围内通过。
- L5（复现）：固定 seed 下关键指标稳定，矩阵回归可重复。


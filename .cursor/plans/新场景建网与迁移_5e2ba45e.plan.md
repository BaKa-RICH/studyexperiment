---
name: 新场景建网与迁移
overview: 基于 SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md 设计规格，创建新的 SUMO 多车道合流路网并将现有三策略迁移到新场景。分两阶段：先建网验收，再代码适配。
todos:
  - id: wait-review
    content: 等待评审结果，确认规格文档无重大改动
    status: pending
  - id: a1-nod
    content: 阶段A1：编写 .nod.xml（7个节点）
    status: pending
  - id: a2-edg
    content: 阶段A2：编写 .edg.xml（6条边，含车道数和限速）
    status: pending
  - id: a3-con
    content: 阶段A3：编写 .con.xml（三组连接约束，最关键）
    status: pending
  - id: a4-netconvert
    content: 阶段A4：netconvert 生成 .net.xml 并按验收清单检查
    status: pending
  - id: a5-rou
    content: 阶段A5：编写 .rou.xml（per-lane flow + route）
    status: pending
  - id: a6-sumocfg
    content: 阶段A6：编写 .sumocfg
    status: pending
  - id: b1-nocontrol
    content: 阶段B1：no_control 零改动试跑，验证 SUMO 层正确
    status: pending
  - id: b2-dtomerge
    content: 阶段B2：修复 d_to_merge 对 aux lane 车辆的 fallback
    status: pending
  - id: b3-lanechange
    content: 阶段B3：增加 laneChangeMode 分角色设置
    status: pending
  - id: b4-lanefilter
    content: 阶段B4：控制对象按 lane 过滤（可选，建议后做）
    status: pending
  - id: b5-fifo-dp
    content: 阶段B5：fifo/dp 迁移验证，跑通并对比指标
    status: pending
isProject: false
---

# 新场景建网与三策略迁移计划

## 前置条件

- 等待评审结果确认 [SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md](docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md) 规格无重大改动
- 如有改动，先修订规格文档再动手

## 阶段 A：SUMO 路网与车流文件（纯 SUMO 层，不改 Python）

目标目录：`ramp/scenarios/ramp_paper0_mlane_v1/`

### A1. 编写节点文件 `.nod.xml`

按规格 4.2.1 创建 7 个节点：

- 主线：`n_main_0(0,0)` / `n_main_1(200,0)` / `n_main_2(500,0)` / `n_merge(800,0)` / `n_main_3(1000,0)`
- 匝道：`n_ramp_0(153.59,-200)` / `n_ramp_1(240.19,-150)`

### A2. 编写边文件 `.edg.xml`

按规格 4.2.2 创建 6 条 edge：

- `main_h1`(4L, 25m/s) / `main_h2`(4L, 25m/s) / `main_h3`(5L, 25m/s) / `main_h4`(4L, 25m/s)
- `ramp_h5`(2L, 16.7m/s) / `ramp_h6`(2L, 16.7m/s, to=n_main_2)

### A3. 编写连接文件 `.con.xml`（本阶段最关键的文件）

三组连接约束（规格 4.4）：

- **main_h2 -> main_h3**：4条 lane 对齐到 lane1-4，lane0(aux) 不接主线
- **ramp_h6 -> main_h3**：lane0/1 都接 main_h3 lane0
- **main_h3 -> main_h4**（n_merge）：lane0 无下游连接（aux 终止），lane1-4 分别接 lane0-3

### A4. netconvert 生成 `.net.xml` + 验收

生成命令示意：

```bash
netconvert --node-files=xxx.nod.xml --edge-files=xxx.edg.xml --connection-files=xxx.con.xml -o xxx.net.xml --no-turnarounds
```

验收清单（规格第 10 节）：

- 车道数正确：main_h1/h2/h4=4, main_h3=5, ramp_h5/h6=2
- 连接映射正确：主线不进 aux，ramp 进 aux，aux 在 n_merge 终止
- internal edge 速度不出现异常低值（特别是 `:n_ramp_1_*` 和 `:n_main_2_*`）
- junction id `n_merge` 存在且产生 `:n_merge_*` internal edges

### A5. 编写车流文件 `.rou.xml`

- vType `cav`：保持与 v1 一致（accel=2.6, decel=4.5, tau=1.0, sigma=0.0）
- route：`main_route = main_h1 main_h2 main_h3 main_h4`，`ramp_route = ramp_h5 ramp_h6 main_h3 main_h4`
- 主线 4 条 per-lane flow（`flow_main_L0..L3`），匝道 2 条（`flow_ramp_R0` 暂 0，`flow_ramp_R1` 出流）
- 初始用中等流量（如 main=1200 veh/h/lane, ramp=500 veh/h/lane）便于调试

### A6. 编写 `.sumocfg`

引用新的 net 和 rou 文件。

---

## 阶段 B：代码适配（需改 Python）

### B1. `no_control` 先跑通（零改动验证）

直接用 `--scenario ramp_paper0_mlane_v1 --policy no_control` 试跑。预期：

- stream 判别正常（route 首边前缀兼容）
- `d_to_merge` 对主线车正常，对 aux lane 车可能异常
- 如果跑通且无 crash，说明基础 SUMO 层正确

### B2. 修复 `d_to_merge` 对 aux lane 车辆的异常值

位置：[state_collector.py](ramp/runtime/state_collector.py) 的 `_distance_to_merge()` 函数

当车辆在 `main_h3_0`（aux lane）上时，`getDrivingDistance(veh_id, "main_h4", 0.0)` 可能返回 -1（因为 lane0 在 n_merge 无下游连接到 main_h4）。需要增加 fallback：

- 如果返回 -1 且车辆在 main_h3 lane0，用 `main_h3_length - lane_pos` 作为近似 d_to_merge

### B3. 增加 `laneChangeMode` 分角色设置

位置：[controller.py](ramp/runtime/controller.py) 或 [run.py](ramp/experiments/run.py)

- 主线车辆（stream=main，在 main_h3 lane1-4 上）：设置 `laneChangeMode` 禁止自由换道
- 匝道车辆（stream=ramp，在 main_h3 lane0 上）：保持默认（允许 SUMO 自动换道到 lane1）

### B4. 控制对象按 lane 过滤（E1 方案）

位置：[state_collector.py](ramp/runtime/state_collector.py) 的 `collect()` 方法

在 `control_zone_state` 构建时增加 lane 过滤：只有 main_h3 的 lane0（aux）和 lane1（冲突车道）上的车辆才纳入控制。lane2/3/4 的主线车自由行驶，不计入调度。

**注意：B4 是否在 v1 就做是一个决策点**——可以先不做 lane 过滤，让三策略对全部进入控制区的车辆都控制（和 v1 行为一致），先验证基础跑通；之后再加 lane 过滤优化。

### B5. fifo/dp 迁移验证

- fifo：应直接兼容（调度逻辑不依赖 lane）
- dp：应直接兼容（DP 调度核心 `dp_schedule()` 只看 main_seq/ramp_seq 和 t_min_s）
- 跑通后对比 no_control，确认控制确实在起作用

---

## 已知风险与需讨论的点

1. **aux lane 末端换道失败**（规格 11.2）：高流量下匝道车可能堵在 lane0 末端，需要监控
2. **内部边限速过低**：匝道进入合流区入口如果转角过急，internal edge 可能被限到很低的速度
3. **B4 的 lane 过滤是否纳入 v1**：建议先不做，跑通后再加
4. **匝道车在 aux lane 上的 stream_vmax 该用哪个值**：16.7（匝道限速）还是 25.0（aux lane 限速）？影响 fifo 的 natural_eta 和 dp 的 t_min 计算


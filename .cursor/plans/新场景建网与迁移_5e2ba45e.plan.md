---
name: 新场景建网与迁移
overview: 基于 SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md 设计规格，创建新的 SUMO 多车道合流路网并将现有三策略迁移到新场景。分两阶段：先建网验收，再代码适配。
todos:
  - id: wait-review
    content: 等待评审结果，确认规格文档无重大改动
    status: pending
  - id: a1-nod
    content: 阶段A1：编写 .nod.xml（7个节点）
    status: pending
  - id: a2-edg
    content: 阶段A2：编写 .edg.xml（6条边，含车道数和限速）
    status: pending
  - id: a3-con
    content: 阶段A3：编写 .con.xml（三组连接约束，最关键）
    status: pending
  - id: a4-netconvert
    content: 阶段A4：netconvert 生成 .net.xml 并按验收清单检查
    status: pending
  - id: a5-rou
    content: 阶段A5：编写 .rou.xml（per-lane flow + route）
    status: pending
  - id: a6-sumocfg
    content: 阶段A6：编写 .sumocfg
    status: pending
  - id: b1-lane-filter
    content: 阶段B1（核心）：控制对象按 lane 过滤（E-ctrl-1），参数化 --control-mode
    status: pending
  - id: b2-lanechange
    content: 阶段B2：laneChangeMode 分角色设置（主线禁换道，匝道只允许换到 lane1），参数化 --ramp-lc-target-lane
    status: pending
  - id: b3-aux-vmax
    content: 阶段B3：匝道车在 aux lane 上 stream_vmax 切换为 25.0，参数化可切回 16.7
    status: pending
  - id: b4-verify
    content: 阶段B4：三策略验证（no_control/fifo/dp 对比 + seeds 基线矩阵）
    status: pending
isProject: false
---

# 新场景建网与三策略迁移计划

## 前置条件

- 等待评审结果确认 [SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md](docs/SCENARIO_RAMP_PAPER0_MLANE_V1_SPEC.md) 规格无重大改动
- 如有改动，先修订规格文档再动手

## 阶段 A：SUMO 路网与车流文件（纯 SUMO 层，不改 Python）

目标目录：`ramp/scenarios/ramp_paper0_mlane_v1/`

### A1. 编写节点文件 `.nod.xml`

按规格 4.2.1 创建 7 个节点：

- 主线：`n_main_0(0,0)` / `n_main_1(200,0)` / `n_main_2(500,0)` / `n_merge(800,0)` / `n_main_3(1000,0)`
- 匝道：`n_ramp_0(153.59,-200)` / `n_ramp_1(240.19,-150)`

### A2. 编写边文件 `.edg.xml`

按规格 4.2.2 创建 6 条 edge：

- `main_h1`(4L, 25m/s) / `main_h2`(4L, 25m/s) / `main_h3`(5L, 25m/s) / `main_h4`(4L, 25m/s)
- `ramp_h5`(2L, 16.7m/s) / `ramp_h6`(2L, 16.7m/s, to=n_main_2)

### A3. 编写连接文件 `.con.xml`（本阶段最关键的文件）

三组连接约束（规格 4.4）：

- **main_h2 -> main_h3**：4条 lane 对齐到 lane1-4，lane0(aux) 不接主线
- **ramp_h6 -> main_h3**：lane0/1 都接 main_h3 lane0
- **main_h3 -> main_h4**（n_merge）：lane0 无下游连接（aux 终止），lane1-4 分别接 lane0-3

### A4. netconvert 生成 `.net.xml` + 验收

生成命令示意：

```bash
netconvert --node-files=xxx.nod.xml --edge-files=xxx.edg.xml --connection-files=xxx.con.xml -o xxx.net.xml --no-turnarounds
```

验收清单（规格第 10 节）：

- 车道数正确：main_h1/h2/h4=4, main_h3=5, ramp_h5/h6=2
- 连接映射正确：主线不进 aux，ramp 进 aux，aux 在 n_merge 终止
- internal edge 速度不出现异常低值（特别是 `:n_ramp_1_*` 和 `:n_main_2_*`）
- junction id `n_merge` 存在且产生 `:n_merge_*` internal edges

### A5. 编写车流文件 `.rou.xml`

- vType `cav`：保持与 v1 一致（accel=2.6, decel=4.5, tau=1.0, sigma=0.0）
- route：`main_route = main_h1 main_h2 main_h3 main_h4`，`ramp_route = ramp_h5 ramp_h6 main_h3 main_h4`
- 主线 4 条 per-lane flow（`flow_main_L0..L3`），匝道 2 条（`flow_ramp_R0` 暂 0，`flow_ramp_R1` 出流）
- 初始用中等流量（如 main=1200 veh/h/lane, ramp=500 veh/h/lane）便于调试

### A6. 编写 `.sumocfg`

引用新的 net 和 rou 文件。

---

## 阶段 B：Runtime 适配（需改 Python，Policy/Core Algorithm 层不改）

阶段A已验证：三策略零改动均可在新场景跑通（解耦良好）。
阶段B的目标：让 fifo/dp **只控制冲突车道上的车辆**，并正确设置换道与速度语义。

### 前置结论（阶段A已验收，不再重做）

- `d_to_merge` 对 aux lane 车辆**无异常**（阶段A Step5.2 已验证：231 条 aux 记录，missing=0, neg=0, huge=0），不需要额外 fallback
- 三策略零改动可直接复用（不是"迁移"），阶段A Step5.1 已验证
- internal edge 限速：匝道入口处 13.56/14.29 m/s（30 度转角），不是个位数，不阻塞

### B1. 控制对象按 lane 过滤（核心，参数化）

位置：[state_collector.py](ramp/runtime/state_collector.py) 的 `collect()` 方法
新增参数：[run.py](ramp/experiments/run.py) 增加 `--control-mode`（默认 `E-ctrl-1`，可选 `E-ctrl-2`）

E-ctrl-1 过滤逻辑（规格 6.1 伪代码直译）：

- 主线车（stream=main）：只有 `main_h2 lane0` 和 `main_h3 lane1` 上的车纳入控制
- 匝道车（stream=ramp）：`ramp_h6` 上、`main_h3 lane0`（aux）和 `main_h3 lane1`（已换道）上的车纳入控制
- 其余车辆（main_h3 lane2/3/4 等）自由行驶，不进入 `control_zone_state`

E-ctrl-2：保持现状，距离内全部车辆都纳入（用于对比实验）

效果：算法候选集从"控制区所有车"缩减到"只有冲突车道上的车"，main_h3 lane2/3/4 上的主线车不再被 fifo/dp 错误控速。

### B2. laneChangeMode 分角色设置（参数化）

位置：[controller.py](ramp/runtime/controller.py) 或 [run.py](ramp/experiments/run.py)
新增参数：`--ramp-lc-target-lane`（默认 `1`，即匝道车只允许换到 lane1 就停；未来可设为 `-1` 表示不限制）

设置规则：

- 主线车辆（stream=main，在 main_h3 lane1-4 上）：设 `laneChangeMode` 禁止所有自由换道（保持车道）
- 匝道车辆（stream=ramp，在 main_h3 lane0 上）：允许换道到 lane1，但到达 lane1 后禁止继续向左换道到 lane2/3/4
- 当 `--ramp-lc-target-lane=-1` 时，匝道车到达 lane1 后不限制继续换道

背景：阶段A数据显示匝道车存在从 lane0 一路换到 lane2/3 的行为（ramp+main_h3_2=212行, ramp+main_h3_3=93行），现阶段需要限制。

### B3. 匝道车在 aux lane 上的 stream_vmax 切换为 25.0（参数化）

位置：[state_collector.py](ramp/runtime/state_collector.py) 的 `_stream_vmax()`、[dp/scheduler.py](ramp/policies/dp/scheduler.py) 的 `_stream_vmax()`、[fifo/command_builder.py](ramp/policies/fifo/command_builder.py) 和 [dp/command_builder.py](ramp/policies/dp/command_builder.py) 的 `_stream_vmax()`

改动：当匝道车（stream=ramp）位于 aux lane（`main_h3 lane0`）或已换道到 `main_h3 lane1` 时，有效速度上限用 25.0 而非 16.7。

参数化方式：可在 `--ramp-vmax-mps` 之外新增 `--aux-vmax-mps`（默认 25.0），或复用 `--main-vmax-mps` 作为 aux lane 上限。以便做 A/B 对比验证（规格 5.4 节）。

影响范围：

- fifo 的 `natural_eta` 计算（匝道车预计更早到达，排序可能变化）
- dp 的 `t_min` 计算（同上）
- command_builder 的 `v_des` 上限（允许匝道车在 aux 上跑到 25）

### B4. 三策略验证与基线矩阵

验证步骤：

1. 跑 `no_control/fifo/dp` x `seed=1..5`，产出完整输出
2. 对比 no_control，确认 fifo/dp 的控制确实在起作用（吞吐/延误/碰撞指标有差异）
3. 确认 lane2/3/4 上的主线车**未被控速**（从 trace 中检查这些 lane 上没有 `v_des` 记录）
4. 确认匝道车**不再出现在 lane2/3 上**（laneChangeMode 生效）

验收阈值（沿用旧基线口径）：

- dp：collision=0 + check_plans=0 + mismatch=0 是硬门槛
- fifo：作为弱基线，mismatch 只记录不设硬门槛

---

## 已确认的决策记录


| 讨论点                  | 结论                                                                                        |
| -------------------- | ----------------------------------------------------------------------------------------- |
| lane 过滤              | 必做，是阶段B核心（不是"可选"）                                                                         |
| 参数化                  | `--control-mode`（E-ctrl-1/E-ctrl-2）、`--ramp-lc-target-lane`（默认1）、`--aux-vmax-mps`（默认25.0） |
| d_to_merge fallback  | 阶段A已验证无异常，不需要额外改代码                                                                        |
| internal edge 限速     | 30 度转角下 13.56/14.29 m/s，不阻塞，不处理                                                           |
| stream_vmax aux lane | 用 25.0（你已确认）                                                                              |
| 匝道换道范围               | 现阶段限制只换到 lane1（参数化，以后可放开）                                                                 |
| 匝道已换道到 lane1 的车      | 仍纳入控制（stream=ramp + main_h3 lane1 属于冲突车道）                                                 |
| 术语                   | fifo/dp 在新场景是"直接复用"而非"迁移"                                                                 |


## 已知风险（阶段B）

1. **aux lane 末端换道失败**（规格 11.2）：高流量下匝道车可能堵在 lane0 末端，需要在 B4 验证中监控
2. **laneChangeMode 对换道时机的影响**：限制匝道车只换到 lane1 可能在高流量下减少换道机会，需观察是否导致更多 aux 堵塞

